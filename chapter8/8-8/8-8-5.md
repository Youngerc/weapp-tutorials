#8-8-5 客服消息
##接收消息和事件
在页面中使用 <contact-button/> 可以显示进入客服会话按钮。

当用户在客服会话发送消息（或进行某些特定的用户操作引发的事件推送时），微信服务器会将消息（或事件）的数据包（JSON或者XML格式）POST请求开发者填写的URL。开发者收到请求后可以使用发送客服消息接口进行异步回复。

微信服务器在将用户的消息发给小程序的开发者服务器地址（开发设置处配置）后，微信服务器在五秒内收不到响应会断掉连接，并且重新发起请求，总共重试三次，如果在调试中，发现用户无法收到响应的消息，可以检查是否消息处理超时。关于重试的消息排重，有msgid的消息推荐使用msgid排重。事件类型消息推荐使用FromUserName + CreateTime 排重。

服务器收到请求必须做出下述回复，这样微信服务器才不会对此作任何处理，并且不会发起重试，否则，将出现严重的错误提示。详见下面说明：
```
1、直接回复success（推荐方式）
2、直接回复空串（指字节长度为0的空字符串，而不是结构体中content字段的内容为空）
```
一旦遇到以下情况，微信都会在小程序会话中，向用户下发系统提示“该小程序客服暂时无法提供服务，请稍后再试”：
```
1、开发者在5秒内未回复任何内容
2、开发者回复了异常数据
```
如果开发者希望增强安全性，可以在开发者中心处开启消息加密，这样，用户发给小程序的消息以及小程序被动回复用户消息都会继续加密，详见消息加解密说明（https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&t=resource/res_list&verify=1&id=open1419318479&token=&lang=zh_CN ）。

各消息类型的推送JSON、XML数据包结构如下：
###文本消息
用户在客服会话中发送文本消息时将产生如下数据包：

####XML 格式
```xml
<xml>
   <ToUserName><![CDATA[toUser]]></ToUserName>
   <FromUserName><![CDATA[fromUser]]></FromUserName>
   <CreateTime>1482048670</CreateTime>
   <MsgType><![CDATA[text]]></MsgType>
   <Content><![CDATA[this is a test]]></Content>
   <MsgId>1234567890123456</MsgId>
</xml>

```
####JSON 格式
```json
{
    "ToUserName": "toUser",
    "FromUserName": "fromUser",
    "CreateTime": 1482048670,
    "MsgType": "text",
    "Content": "this is a test",
    "MsgId": 1234567890123456
}
```
参数说明

|参数	|说明|
|:--|:--|
|ToUserName	|小程序的原始ID|
|FromUserName	|发送者的openid|
|CreateTime	|消息创建时间(整型）|
|MsgType	|text|
|Content	|文本消息内容|
|MsgId	|消息id，64位整型|
###图片消息
用户在客服会话中发送图片消息时将产生如下数据包：

####XML 格式
```xml
<xml>
      <ToUserName><![CDATA[toUser]]></ToUserName>
      <FromUserName><![CDATA[fromUser]]></FromUserName>
      <CreateTime>1482048670</CreateTime>
      <MsgType><![CDATA[image]]></MsgType>
      <PicUrl><![CDATA[this is a url]]></PicUrl>
      <MediaId><![CDATA[media_id]]></MediaId>
      <MsgId>1234567890123456</MsgId>
</xml>
```
####JSON 格式
```json
{
    "ToUserName": "toUser",
    "FromUserName": "fromUser",
    "CreateTime": 1482048670,
    "MsgType": "image",
    "PicUrl": "this is a url",
    "MediaId": "media_id",
    "MsgId": 1234567890123456
}

```
参数说明

|参数	|说明|
|:--|:--|
|ToUserName	|小程序的原始ID|
|FromUserName	|发送者的openid|
|CreateTime	|消息创建时间(整型）|
|MsgType	|image|
|PicUrl	|图片链接（由系统生成）|
|MediaId	|图片消息媒体id，可以调用获取临时素材接口拉取数据|
|MsgId	|消息id，64位整型|
###进入会话事件
用户在小程序“客服会话按钮”进入客服会话时将产生如下数据包：

####XML 格式
```xml
<xml>
    <ToUserName><![CDATA[toUser]]></ToUserName>  
    <FromUserName><![CDATA[fromUser]]></FromUserName>  
    <CreateTime>1482048670</CreateTime>  
    <MsgType><![CDATA[event]]></MsgType>  
    <Event><![CDATA[user_enter_tempsession]]></Event>  
    <SessionFrom><![CDATA[sessionFrom]]></SessionFrom> 
</xml>

```
####JSON 格式
```json
{
    "ToUserName": "toUser",
    "FromUserName": "fromUser",
    "CreateTime": 1482048670,
    "MsgType": "event",
    "Event": "user_enter_tempsession",
    "SessionFrom": "sessionFrom"
}

```
参数说明

|参数	|说明|
|:--|:--|
|ToUserName	|小程序的原始ID|
|FromUserName	|发送者的openid|
|CreateTime	|事件创建时间(整型）|
|MsgType	|event|
|Event	|事件类型，user_enter_tempsession|
|SessionFrom	|开发者在客服会话按钮设置的sessionFrom参数|
##发送客服消息
当用户和小程序客服产生特定动作的交互时（具体动作列表请见下方说明），微信将会把消息数据推送给开发者，开发者可以在一段时间内（目前修改为48小时）调用客服接口，通过POST一个JSON数据包来发送消息给普通用户。此接口主要用于客服等有人工消息处理环节的功能，方便开发者为用户提供更加优质的服务。

目前允许的动作列表如下，不同动作触发后，允许的客服接口下发消息条数和下发时限不同。下发条数达到上限后，会收到错误返回码，具体请见返回码说明页：

|用户动作	|允许下发条数限制|	下发时限|
|:--|:--|:--|
|用户通过客服消息按钮进入会话|	1条|	1分钟|
|用户发送信息	|3条	|48小时|
###客服接口-发消息
接口调用请求说明

http请求方式: POST
```
https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=ACCESS_TOKEN
```
各消息类型所需的JSON数据包如下：

发送文本消息
```json
{
"touser":"OPENID",
"msgtype":"text",
"text":
{
"content":"Hello World"
}
}
```
发送图片消息
```json
{
"touser":"OPENID",
"msgtype":"image",
"image":
{
"media_id":"MEDIA_ID"
}
}
```
参数说明

|参数	|是否必须	|说明|
|:--|:--|:--|
|access_token	|是	|调用接口凭证|
|touser	        |是	|普通用户	openid|
|msgtype	|是	|消息类型，文本为text，图片为image|
|content	|是	|文本消息内容|
|media_id	|是	|发送的图片的媒体ID，通过新增素材接口（https://mp.weixin.qq.com/debug/wxadoc/dev/api/custommsg/material.html ）上传图片文件获得。|

返回码说明

|参数	|说明|
|:--|:--|
|-1	|系统繁忙，此时请开发者稍候再试|
|0	|请求成功|
|40001	|获取access_token时AppSecret错误，或者access_token无效。请开发者认真比对AppSecret的正确性，或查看是否正在为恰当的小程序调用接口|
|40002	|不合法的凭证类型|
|40003	|不合法的OpenID，请开发者确认OpenID否是其他小程序的OpenID|
|45015	|回复时间超过限制|
|45047	|客服接口下行条数超过上限|
|48001	|api功能未授权，请确认小程序已获得该接口|